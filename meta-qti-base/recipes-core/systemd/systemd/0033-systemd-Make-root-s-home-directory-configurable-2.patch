From 815bc509a70246d8868e37d6805137940a1a9f2e Mon Sep 17 00:00:00 2001
From: Chen Qi <Qi.Chen@windriver.com>
Date: Tue, 26 Nov 2019 10:31:30 +0800
Subject: [PATCH] Make root's home directory configurable

OpenEmbedded has a configurable home directory for root. Allow
systemd to be built using its idea of what root's home directory
should be.

Upstream-Status: Denied
Upstream wants to have a unified hierarchy where everyone is
using the same root folder.
https://github.com/systemd/systemd/issues/541

Signed-off-by: Dan McGregor <dan.mcgregor@usask.ca>
Signed-off-by: Khem Raj <raj.khem@gmail.com>
Signed-off-by: Chen Qi <Qi.Chen@windriver.com>

Signed-off-by: Lei wang <leiwan@codeaurora.org>
---
 meson.build           | 7 +++++++
 meson_options.txt     | 2 ++
 src/basic/user-util.c | 4 ++--
 src/nspawn/nspawn.c   | 4 ++--
 4 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/meson.build b/meson.build
index 79b762f..1084c2a 100644
--- a/meson.build
+++ b/meson.build
@@ -111,6 +111,11 @@ if rootlibdir == ''
         rootlibdir = join_paths(rootprefixdir, libdir.split('/')[-1])
 endif
 
+roothomedir = get_option('roothomedir')
+if roothomedir == ''
+        roothomedir = '/root'
+endif
+
 # Dirs of external packages
 pkgconfigdatadir = get_option('pkgconfigdatadir') == '' ? join_paths(datadir, 'pkgconfig') : get_option('pkgconfigdatadir')
 pkgconfiglibdir = get_option('pkgconfiglibdir') == '' ? join_paths(libdir, 'pkgconfig') : get_option('pkgconfiglibdir')
@@ -233,6 +238,7 @@ conf.set_quoted('UDEVLIBEXECDIR',                             udevlibexecdir)
 conf.set_quoted('POLKIT_AGENT_BINARY_PATH',                   join_paths(bindir, 'pkttyagent'))
 conf.set_quoted('LIBDIR',                                     libdir)
 conf.set_quoted('ROOTLIBDIR',                                 rootlibdir)
+conf.set_quoted('ROOTHOMEDIR',                                roothomedir)
 conf.set_quoted('ROOTLIBEXECDIR',                             rootlibexecdir)
 conf.set_quoted('BOOTLIBDIR',                                 bootlibdir)
 conf.set_quoted('SYSTEMD_PULL_PATH',                          join_paths(rootlibexecdir, 'systemd-pull'))
@@ -252,6 +258,7 @@ substs.set('rootprefix_noslash',                              rootprefixdir_nosl
 substs.set('exec_prefix',                                     prefixdir)
 substs.set('libdir',                                          libdir)
 substs.set('rootlibdir',                                      rootlibdir)
+substs.set('roothomedir',                                     roothomedir)
 substs.set('includedir',                                      includedir)
 substs.set('sysconfdir',                                      sysconfdir)
 substs.set('bindir',                                          bindir)
diff --git a/meson_options.txt b/meson_options.txt
index 5dc898e..ce3c88e 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -12,6 +12,8 @@ option('rootlibdir', type : 'string',
        description : '''[/usr]/lib/x86_64-linux-gnu or such''')
 option('rootprefix', type : 'string',
        description : '''override the root prefix [default '/' if split-usr and '/usr' otherwise]''')
+option('roothomedir', type : 'string',
+       description : '''override the root home directory''')
 option('link-udev-shared', type : 'boolean',
        description : 'link systemd-udev and its helpers to libsystemd-shared.so')
 option('link-systemctl-shared', type: 'boolean',
diff --git a/src/basic/user-util.c b/src/basic/user-util.c
index 3b253bc..b70c382 100644
--- a/src/basic/user-util.c
+++ b/src/basic/user-util.c
@@ -127,7 +127,7 @@ static int synthesize_user_creds(
                         *gid = 0;
 
                 if (home)
-                        *home = "/root";
+                        *home = ROOTHOMEDIR;
 
                 if (shell)
                         *shell = "/bin/sh";
@@ -472,7 +472,7 @@ int get_home_dir(char **_h) {
         /* Hardcode home directory for root and nobody to avoid NSS */
         u = getuid();
         if (u == 0) {
-                h = strdup("/root");
+                h = strdup(ROOTHOMEDIR);
                 if (!h)
                         return -ENOMEM;
 
diff --git a/src/nspawn/nspawn.c b/src/nspawn/nspawn.c
index 2aec804..6fd41e2 100644
--- a/src/nspawn/nspawn.c
+++ b/src/nspawn/nspawn.c
@@ -3035,7 +3035,7 @@ static int inner_child(
                 n_env++;
 
         if (home || !uid_is_valid(arg_uid) || arg_uid == 0)
-                if (asprintf((char**)(envp + n_env++), "HOME=%s", home ?: "/root") < 0)
+                if (asprintf((char**)(envp + n_env++), "HOME=%s", home ?: ROOTHOMEDIR) < 0)
                         return log_oom();
 
         if (arg_user || !uid_is_valid(arg_uid) || arg_uid == 0)
@@ -3129,7 +3129,7 @@ static int inner_child(
         } else {
                 if (!arg_chdir)
                         /* If we cannot change the directory, we'll end up in /, that is expected. */
-                        (void) chdir(home ?: "/root");
+                        (void) chdir(home ?: ROOTHOMEDIR);
 
                 execle("/bin/bash", "-bash", NULL, env_use);
                 execle("/bin/sh", "-sh", NULL, env_use);
-- 
2.7.4

