From 7ba32a4fa2cdb9927f78822dc22cab10101b96bc Mon Sep 17 00:00:00 2001
From: Lei wang <leiwan@codeaurora.org>
Date: Tue, 5 Nov 2019 14:05:47 +0800
Subject: [PATCH] systemd: add slotselect support in fstab

support a/b partition option in fstab

Signed-off-by: Lei wang <leiwan@codeaurora.org>
---
 src/core/mount.c                      |  2 +-
 src/fstab-generator/fstab-generator.c | 13 +++++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/src/core/mount.c b/src/core/mount.c
index 959b8fbed2..39478249ff 100644
--- a/src/core/mount.c
+++ b/src/core/mount.c
@@ -978,7 +978,7 @@ static void mount_enter_mounting(Mount *m) {
         if (p) {
                 _cleanup_free_ char *opts = NULL;
 
-                r = fstab_filter_options(p->options, "nofail\0" "noauto\0" "auto\0", NULL, NULL, &opts);
+                r = fstab_filter_options(p->options, "nofail\0" "noauto\0" "auto\0" "slotselect\0", NULL, NULL, &opts);
                 if (r < 0)
                         goto fail;
 
diff --git a/src/fstab-generator/fstab-generator.c b/src/fstab-generator/fstab-generator.c
index 76270aec17..98413e5d26 100644
--- a/src/fstab-generator/fstab-generator.c
+++ b/src/fstab-generator/fstab-generator.c
@@ -51,6 +51,7 @@ static char *arg_usr_what = NULL;
 static char *arg_usr_fstype = NULL;
 static char *arg_usr_options = NULL;
 static VolatileMode arg_volatile_mode = _VOLATILE_MODE_INVALID;
+static char* slot_suffix = NULL;
 
 STATIC_DESTRUCTOR_REGISTER(arg_root_what, freep);
 STATIC_DESTRUCTOR_REGISTER(arg_root_fstype, freep);
@@ -576,6 +577,18 @@ static int parse_fstab(bool initrd) {
                 growfs = fstab_test_option(me->mnt_opts, "x-systemd.growfs\0");
                 noauto = fstab_test_yes_no_option(me->mnt_opts, "noauto\0" "auto\0");
                 nofail = fstab_test_yes_no_option(me->mnt_opts, "nofail\0" "fail\0");
+                /*
+                 * update what for slot support
+                 */
+                if (fstab_test_option(me->mnt_opts, "slotselect\0")) {
+                        if (slot_suffix || proc_cmdline_get_key("androidboot.slot_suffix", 0, &slot_suffix)) {
+                                realloc(what, strlen(what) + strlen(slot_suffix) + 1);
+                                strncat(what, slot_suffix, strlen(slot_suffix));
+                                log_info("slotselect mount target changed to '%s' suffix is '%s'.", what, slot_suffix);
+                        }
+                        else
+                                log_warning("slotselect is not supported in cmdline, mount target changed to default '%s'.", what);
+                }
 
                 log_debug("Found entry what=%s where=%s type=%s makefs=%s growfs=%s noauto=%s nofail=%s",
                           what, where, me->mnt_type,
-- 
2.14.0.rc1.14.gc3eb4e6

